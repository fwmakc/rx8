# Цикл выполнения инструкций — извлечение, декодирование, выполнение

Теперь у меня есть набор инструкций и игровые данные, готовые к интерпретации. Процессор просто должен что-то с ним сделать. Цикл инструкции состоит из трёх этапов — извлечения, декодирования и выполнения.

- Извлечение (fetch) — получение данных, хранящихся в памяти, при помощи счётчика программы.
- Декодирование — разбор 16-битного опкода для получения декодированной инструкции и значений аргументов.
- Выполнение — выполнение операции на основе декодированной инструкции и обновление счётчика программы.

Вот сжатая и упрощённая версия того, как работает цикл. Эти методы цикла ЦП являются частными и не раскрываются.

Первый шаг, fetch, обращается к текущему опкоду из памяти.

```
// Берём адрес из памяти
function fetch() {
  return memory[PC]
}
```

decode разберёт опкод на понятный набор команд:

```
// Декодируем инструкцию
function decode(opcode) {
  return disassemble(opcode)
}
```

Execute состоит из switch со всеми 36 инструкциями в качестве case, и выполнит для найденной инструкции соответствующую операцию, обновив затем счётчик программы, чтобы следующий цикл извлечения нашёл следующий опкод. Любая обработка ошибок будет проходить здесь же, что приведёт к остановке процессора.

```
// Выполняем инструкцию
function execute(instruction) {
  const { id, args } = instruction

  switch (id) {
    case 'ADD_VX_VY':
      // Выполняем операцию инструкции
      registers[args[0]] += registers[args[1]]

      // Обновляем счётчик
      PC = PC + 2
      break
    case 'SUB_VX_VY':
    // и т д.
  }
}
```
