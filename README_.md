# Phaser 3 Project Template

Это шаблон проекта на Phaser.

Использует js, nodejs, vite.

## Команды

Управлять проектом можно через менеджеры пакетов npm или yarn.

```yarn```

Установить все зависимости.

```yarn dev```

Запустить проект с отслеживанием изменений.

```yarn build```

Собрать проект в готовом для публикации виде.

По-умолчанию проект запускается по адресу

    http://localhost:5173

# Ретро гейминг

Ретрогейминг - это увлечение старыми играми. Помимо самого игрового процесса, т.е. прохождения игр, ретрогейминг включает в себя коллекционирование, изучение истории и технических моментов старых ЭВМ. Нас интересует создание новых игр, выдержанных в стиле старых игр.

Современный ретрогейминг объединяет ПК и консоли разных годов. Но мы будем касаться только пиксельной графики, 2d и псевдо 3d.

Мы будем исходить из идеи, которую предложили авторы PICO-8. Только здесь мы представим некий не существующий ретро ПК, который также имитирует ограниченные возможности 8-битных компьютеров 1980-х годов.

В процессе разработки появилась идея создать несколько версий ретро ПК:

- RX 80, самая старая, 8 бит,
- RX 86, более новая, 16 бит,
- RX 32, новая, 32 бита,
- RX 64, самая новая, 64 бита.

Название RX - это аббревиатура от Retro PC и X как дань уважения ZX Spectrum, если бы он получил дальнейшее развитие.

## История

Современные процессоры берут начало от процессора 8008 и его преемника 8080 компании Intel. Он являлся технологическим прорывом, однако имел множество ограничений и недоработок. Это способствовало тому, что многие компании выпускали свои процессоры, как правило, обратно совместимые с i8080:

- Zilog Z80, 1-20 МГц, Game Boy, Sinclair ZX Spectrum, игровые автоматы, терминалы, другое оборудование; спроектирован тем же человеком, который проектировал i8080,
- Motorola MC 68000, 8-16 МГц, Amiga, Atari, Apple Macintosh, SEGA,
- MOS Technology 6502, 1-2 МГц, Apple I, Apple II, NES.

Но выпуск i8086 с 16-битной архитектурой завершил эпоху 8-битных процессоров и фактически монополизировал рынок ПК.

Предположим, что была некая компания X, которая разрабатывала свои процессоры:

- X80 как дальнейшее развитие Z80,
- X86 (286/386/486), совместимый с i8086,
- X32 (232/332/...), совместимый с Intel Pentium / AMD K6,
- X64 (64 5600/64 7900/...), совместимый с Intel Core / AMD Ryzen.

## Архитектура

Данный раздел описан не полностью.

- совместимость с системой команд i8080,
- адреса до 16 бит,
- максимальный размер памяти - 64/128/256/512 КБ,
- тактовая частота до 16 МГц,
- BASIC,
- Direct Memory Access для периферийных устройств.

## Периферия

Данный раздел описан не полностью.

Устройства ввода подключались через 9-контактный последовательный порт.

Периферия включала клавиатуру в раскладке QWERTY / ЙЦУКЕН с курсорными клавишами.

Джойстик/геймпад типа Kempston, который работал со своими кодами и мог включать до 4 функциональных клавиш. Возможна параллельная работа двух джойстиков, подключенных одновременно в два порта.

Мышь с 2/3 кнопками.

Чб и цветной дисплей.

Принтер.

Вывод звука.

Модем.

Устройства расширения подключались через порты расширения.

Носители данных - гибкие и жесткие диски, сингал с магнитной ленты.

## Разрешение экрана

### Видеоподсистема RX80

Видеоподсистема RX80 основана на блоках и пикселях.

Существует базовое разрешение экрана в пикселях, которое вы не можете превысить.

Экран состоит из двух областей:

- страницы,
- бордюра.

Для страницы можно задать отступ от левого верхнего края экрана. По-умолчанию она всегда позиционируется прямо по центру.

Страница делится на блоки, которые еще называются знакоместами или спрайтами.

Размер блока вы также можете задать самостоятельно. По-умолчанию он равен 16 х 16 пкс. Но вы можете задать его 8 х 8 пкс (ZX Spectrum) 10 х 10 пкс (CGA) или 10 х 11 (APPLE II) или 4 х 8 (текстовый режим).

Задав размера блока для своей программы, вы уже не можете выйти за эти пределы.

Размер страницы задается числом блоков по горизонтали и вертикали.

Сами блоки кодируются по стандарту ASCII. Это значит, что вы можете закодировать максимум 256 блоков.

### Видеоподсистема RX86

В видеоподсистеме RX86 уже нет жесткой привязки к одному размеру блока. Вы можете использовать блоки любого размера.

Разрешение RX86 вдвое превосходит разрешение RX80. Это означает, что запуск игр RX80 на RX86 возможен, но при этом будет аппаратный upscale 2x.

Таблица базовых разрешений

|      платформа |      RX80 |      RX86 |
|     разрешение | 320 x 240 | 640 x 480 |

### Видеоподсистема RX32

В видеоподсистеме RX32 вы можете использовать любое разрешение.

Запуск игр с платформ RX80 и RX86 также возможен, но при этом разрешение будет аппаратно изменено на соответствующее.

### Сравнение разрешений экрана разных платформ

|      платформа |       CGA |       VGA |        ZX |       NES |      SEGA |  APPLE II |    PICO-8 | 
|     разрешение | 320 х 200 | 320 х 240 | 256 х 192 | 256 х 224 | 320 х 224 | 280 х 192 | 128 х 128 |

## Цветовая палитра

### Цвет видеоподсистемы RX80

Цвет видеоподсистемы RX80 основан на палитрах.

Вы можете задать цвет:

- для всего экрана (по-умолчанию черный),
- для блока (по-умолчанию прозрачный),
- для пикселя (по-умолчанию белый).

Любой цвет кодируется 4 битами (0-F), которые обозначают код цвета в палитре.

В видеопамяти хранится палитра на 16 цветов.

По-молчанию это:

0 00.00.00 0000.0000.0000 черный
1 00.00.FF 0000.0000.1111 синий
2 00.FF.00 0000.1111.0000 светло-зеленый, салатный
3 00.FF.FF 0000.1111.1111 светло-голубой, бирюзовый
4 FF.00.00 1111.0000.0000 красный
5 FF.00.FF 1111.0000.1111 розовый
6 FF.FF.00 1111.1111.0000 светло-оранжевый, желтый
7 FF.FF.FF 1111.1111.1111 белый
8 00.00.AA 0000.0000.1010 темно-синий
9 00.AA.00 0000.1010.0000 зеленый
A 00.AA.AA 0000.1010.1010 голубой
B AA.00.00 1010.0000.0000 темно-красный, бордовый
C AA.00.AA 1010.0000.1010 темно-розовый, фиолетовый
D AA.AA.00 1010.1010.0000 оранжевый
E AA.AA.AA 1010.1010.1010 серый
F 00.00.00 0000.0000.0000 нет цвета, черный или прозрачный

Можно использовать альтернативную палитру с более пастельными тонами:

0 000000 черный
1 2F484E синий
2 A3CE27 светло-зеленый, салатный
3 B2DCEF светло-голубой, бирюзовый
4 E06F8B красный
5 EB8931 розовый
6 F7E26B светло-оранжевый, желтый
7 FFFFFF белый
8 1B2632 темно-синий
9 44891A зеленый
A 31A2F2 голубой
B BE2633 темно-красный, бордовый
C A46422 темно-розовый, фиолетовый
D AE9D33 оранжевый
E 9D9D9D серый
F 005784 / 493C2A дополнительный цвет, светло-голубой или темно-коричневый

### Распределение видеопамяти RX80

блоки

при максимальных размерах блока 16 х 16 пикселей, блок кодируется
256 пикселей по 4 бита = 1024 бита / 128 байт

262 144 бита / 32 768 байт - на кодировку всех 256 блоков при максимальном размере 16 х 16 пикселей

если блоков меньше или размер блока меньше, остается незанятая память

адреса х000000-x03FFFF

цвета и палитры

12 бит / 1,5 байта, адреса x00-x0B - на цвет
192 бита / 24 байта, адреса x00-xBF - на цвета палитры
768 бит / 96 байт, адреса x0000-x02FF - на все цвета всех палитр
адреса х040000-х0402FF

текущая палитра

2 бита
адреса х040300-х040301

цвет экрана

2 пустых бита
2 бита
адреса х040302-х040307

размеры блока

4 бита / 0,5 байт - на размер блока в пикселях по одной стороне
8 бит / 1 байт - на размер блока в пикселях по горизонтали и вертикали

адреса х040308-х04030F

страница

8 бит / 1 байт - на смещение в блоках по одной стороне
16 бит / 2 байта - на смещение в блоках по горизонтали и вертикали

адреса х040310-х04031F

адреса х040320-х0403FF

### Цвет видеоподсистемы RX86

Цвет видеоподсистемы RX86 основан на палитре из 256 цветов. Но по-сути, это палитра всего из 16 базовых цветов.

Палитра также построена на базовых цветах RX80, но расширяет их за счет переходных цветов (оттенков) и различных уровней яркости и насыщенности.

Это стало возможным благодаря увеличению разрядности, которое позволило использовать больший объем памяти.

Это также означает, что запуск игр RX80 на RX86 возможен, но при этом аппаратно цвета и палитры будут преобразованы из нескольких палитр в одно пространство.

В палитре RX86 цвет представлен не в формате RGB, а в формате HSL (hue, saturation, lightness).

Оттенок цвета (hue) задается 8 битами или 1 байтом - от 0 до 255.

Яркость (lightness) и насыщенность (saturation) устанавливаются еще 1 байтом, по 4 бита для каждого - от 0 до 15.

Таким образом, мы по-сути формируем 1 палитру из 16 цветов и ее составляющие. Код цвета задается 1 байтом из двух разрядов.

Старший отвечает, собственно, за сам код. Младший - за составляющую.

Например, для красного цвета доступны коды от 10 до 1F:

код H  S L H        S    L
1.0 01.0.0 00000001.0000.0000
1.1 01.0.5 00000001.0000.0101
1.2 01.0.A 00000001.0000.1010
1.3 01.0.F 00000001.0000.1111
1.4 01.5.0 00000001.0101.0000
1.5 01.5.5 00000001.0101.0101
1.6 01.5.A 00000001.0101.1010
1.7 01.5.F 00000001.0101.1111

В итоге получается своего рода квадрат:

660000 CC0000 FF3333 FF9999
5B0B0B B71515 EB4747 F5A3A3
511515 A32929 D75B5B EBADAD
471F1F 8E3E3E C27070 E1B7B7

Для черного цвета (код 00-0F) ситуация такова, что он кодируется в оттенки серого, вплоть до белого.

Для белого цвета (код F0-FF) ситуация такова, что он никак не кодируется, в любых оттенках он является белым. При этом код FF соответствует прозрачному цвету.

### Эмуляция палитры RX86

Чтобы эмулировать палитру RX86 в RGB, нужно учитывать, что цвета и оттенки сильно зависят от цветового формата PAL или NTSC.

Реальная яркость каждого цвета по-прежнему лежит где-то в пределах от 8 до 240 и это значит, что яркостные биты можно задавать в ограниченном диапазоне от 08 до EF.

Коды цветов палитры со значениями оттенков (hue, deg):

0 000 черный/серый/белый
1 000 красный
2 020 оранжевый
3 045 золотой
4 060 жетлый
5 078 салатный
6 130 зеленый
7 156 биюзовый
8 182 голубой
9 208 лазурный
A 234 синий
B 260 фиолетовый
C 286 сиреневый
D 312 розовый
E 338 коралловый
F 000 белый / нет цвета, прозрачный

Значения яркости (lightness, %)

80
60
40
20

Значения насыщенности (saturation, %):

100
80
60
40

### Распределение видеопамяти RX86

Каждому цвету присваивается свой код из 8 бит (00-FF).

На каждый цвет теперь идет служебный номер из 8 бит.
Поэтому один цвет занимает в памяти 32 бита = 4 байта.
Вся палитра занимает в памяти 8 192 бита = 1 024 байта = 1 Кб.

Вы можете динамически загружать в память палитру.

Спрайты кодируются следующим образом.

В видеопамяти отведено место под хранение одного изображения размером 640 х 480 пикселей. Всего это 307 200 пикселей. Каждому пикселю назначается свой цветовой код из палитры на 8 бит. Таким образом, изображение занимает в памяти 2 457 600 бит или 307 200 байт или 300 Кб.

Считается, что на этом изображении вы можете разместить 256 символов. Они будут идти последовательно. На каждый символ отводится некоторая служебная информация:

На каждый символ теперь идет служебный номер из 8 бит.
Максимальный размер по горизонтали - 640 пикселей, 12 бит.
Максимальный размер по вертикали - 480 пикселей, 12 бит.

Итого на символ 32 бита = 4 байта.
Итого на все 256 символов 8 192 бита = 1 024 байта = 1 Кб.

Таким образом, память распределяется следующим образом:

- палитра, 8 192 бита = 1 024 байта = 1 Кб,
- текстовое изображение, 2 457 600 бит = 307 200 байт = 300 Кб,
- текстовые символы, 8 192 бита = 1 024 байта = 1 Кб,
- графическое изображение, 2 457 600 бит = 307 200 байт = 300 Кб,
- графические символы, 8 192 бита = 1 024 байта = 1 Кб.

Все это занимает в памяти 603 Кб. Остальная память выделяется под таблицы цветов и расчеты.

Если вам кажется, что этого мало, то для вас есть несколько моментов.

Видеоподсистема RX86 позволяет динамически управлять спрайтами. Например, вы можете задать для спрайта таблицу цветов с указанием кода исходного цвета и кода конечного цвета, чтобы затем менять эти цвета местами.

Например, вы можете создать один спрайт для двух персонажей, который будет содержать только четыре цвета. И потом, при выводе его на экран, переназначить ему эти цвета.

Например, вы можете создать спрайт воды, содержащий только три цвета. И потом, при выводе его на экран, с определенным интервалом времени, менять эти цвета местами.

Текстовая таблица по-сути ничем не отличается от графической таблицы. Поэтому вы можете использовать ее для хранения дополнительных изображений.

Вы можете также подгружать таблицы в память динамически. Например, одну - для заставки, другую - для меню, а также каждую отдельно для разных уровней и даже экранов.

### Цвет видеоподсистемы RX32

Цвет видеоподсистемы RX32 основан уже более современным образом. Любой цвет кодируется 32 битами или 8 байтами (00000000-FFFFFFFF), что позволяет использовать 16 миллионов цветов с 256 степенями прозрачности.

Это стало возможным благодаря увеличению разрядности, которое позволило использовать больший объем памяти.

Также поменялось то, что теперь мы можем назначать любое удобное нам разрешение для экрана.

То же самое коснулось и таблиц. Теперь мы можем хранить неограниченное число спрайтов в одной таблице. Мы можем задавать палитру для каждой таблицы. Мы можем использовать неограниченное число таблиц.

Все упирается только в объем доступной памяти.

Запуск игр RX80 и RX86 также возможен на RX32 с небольшими аппаратными преобразованиями.

### Сравнение цветовых палитр разных платформ

ZX / ZX TV / ZX PASTEL
101010, 101010 / 000000, 000000 / 000000, 000000
1010AA, 1010EC / 002070, 1C3890 / 8854F3, 8E65A5
AA1010, EC1010 / 702800, B03C3C / FF8C5C, E8B382
AA10AA, EC10EC / 6C2088, 9458B4 / FF79AE, D8828E
10AA10, 10EC10 / 399E39, 5CDA5C / 63FFBA, 93D4B5
10AAA0, 10ECEC / 58A4A4, 9CDCDC / 639BFF, 90A9EC
AAAA10, ECEC10 / B8B840, FCFC68 / FFF982, F0DAB1
AAAAAA, ECECEC / B0B0B0, ECECEC / F6F6F6, E2E8DA

CGA
101010, 555555
1010AA, 5555EC
10AA10, 55EC55
10AAAA, 55ECEC
AA1010, EC5555
AA10AA, EC55EC
AA5510, EEDD88
AAAAAA, ECECEC

APPLE II
000000
1BCB01
E434FE
E46501
1B9AFE
FFFFFF

NES / NES WIKI
59595F, AAAAAA, EEEEEE, EEEEEE / 4F4F4F, B8B8B8, FEFEFE, FEFEFE
00008F, 0044DD, 4488FF, 99CCFF / 002A88, 155FDA, 64B0FE, C1E0FE
18008F, 5511EE, 7777FF, AAAAFF / 1412A8, 4240FE, 9390FE, D4D3FE
3F0077, 7700EE, 9944FF, BB99FF / 3B00A4, 7627FF, C777FE, E9C8FE
550055, 9900BB, BB44EE, DD99FF / 5C007E, A11BCD, F36AFE, FBC3FE
550011, AA0055, CC5599, EE99DD / 6E0040, B81E7C, FE6ECD, FEC5EB
550000, 993300, DD6644, EEAAAA / 6C0700, B53220, FE8270, FECDC6
442200, 884400, CC8800, EEBB99 / 571D00, 994F00, EB9F23, F7D9A6
333300, 666600, BBAA00, EEDD88 / 343500, 6C6E00, BDBF00, E5E695
113300, 336600, 77BB00, BBDD88 / 0C4900, 388700, 89D900, D0F097
003311, 006600, 22BB22, 99DD99 / 005200, 0D9400, 5DE530, BEF5AB
004444, 006655, 22BB77, 99DDBB / 004F08, 009032, 45E182, B4F3CD
004466, 005588, 22BBCC, 99DDEE / 00404E, 007C8E, 48CEDF, B5ECF3
000000, 080808, 444444, AAAAAA / 000000, 000000, 666666, AEAEAE

SNES
262726, 514F4C, 887E83, B3AAC0
1B377F, 147ABF, 40AFDD, B2DBF4
181667, 3B2C96, 706AE1, 8F95EE
440A41, 812593, CC4BB9, EC99DB
3F0011, B31C35, EF2064, F26282
960811, E81813, A75D69, EC9EA4
560D04, C43611, E26A12, F0AF66
2A1A14, 5D342A, A66E46, DF9C6E
8E4E11, D89511, EAD11E, F5EB6B
2F541C, 5A831B, A2BB1E, C6DF6B
0F450F, 008B12, 0BCB12, 3EF33F
115153, 0C8563, 04BF79, 6AE6AA
314047, 596D62, 929C74, C8C5A3
000000, 000000, 26232F, FCFCFC

NTSC
000000, 404040, 6C6C6C, 909090, B0B0B0, C8C8C8, DCDCDC, ECECEC
444400, 646410, 848424, A0A034, B8B840, D0D050, E8E85C, FCFC68
702800, 844414, 985C28, AC783C, BC8C4C, CCA05C, DCB468, ECC878
841800, 983418, AC5030, C06848, D0805C, E09470, ECA880, FCBC94
880000, 9C2020, B03C3C, C05858, D07070, E08888, ECA0A0, FCB4B4
78005C, 8C2074, A03C88, B0589C, C070B0, D084C0, DC9CD0, ECB0E0
480078, 602090, 783CA4, 8C58B8, A070CC, B484DC, C49CEC, D4B0FC
140084, 302098, 4C3CAC, 6858C0, 7C70D0, 9488E0, A8A0EC, BCB4FC
000088, 1C209C, 3840B0, 505CC0, 6874D0, 7C8CE0, 90A4EC, A4B8FC
00187C, 1C3890, 3854A8, 5070BC, 6888CC, 7C9CDC, 90B4EC, A4C8FC
002C5C, 1C4C78, 386890, 5084AC, 689CC0, 7CB4D4, 90CCE8, A4E0FC
003C2C, 1C5C48, 387C64, 509C80, 68B494, 7CD0AC, 90E4C0, A4FCD4
003C00, 205C20, 407C40, 5C9C5C, 74B474, 8CD08C, A4E4A4, B8FCB8
143800, 345C1C, 507C38, 6C9850, 84B468, 9CCC7C, B4E490, C8FCA4
2C3000, 4C501C, 687034, 848C4C, 9CA864, B4C078, CCD488, E0EC9C
442800, 644818, 846830, A08444, B89C58, D0B46C, E8CC7C, FCE08C

PAL
000000, 282828, 505050, 747474, 949494, B4B4B4, D0D0D0, ECECEC
703400, 885020, A0683C, B48458, C89870, DCAC84, ECC09C, FCD4B0
700014, 882034, A03C50, B4586C, C87084, DC849C, EC9CB4, FCB0C8
70005C, 842074, 943C88, A8589C, B470B0, C484C0, D09CD0, E0B0E0
580070, 6C2088, 803CA0, 9458B4, A470C8, B484DC, C49CEC, D4B0FC
3C0080, 542094, 6C3CA8, 8058BC, 9470CC, A884DC, B89CEC, C8B0FC
000088, 20209C, 3C3CB0, 5858C0, 7070D0, 8484E0, 9C9CEC, B0B0FC
002070, 1C3C88, 3858A0, 5074B4, 6888C8, 7CA0DC, 90B4EC, A4C8FC
003C70, 1C5888, 3874A0, 508CB4, 68A4C8, 7CB8DC, 90CCEC, A4E0FC
005C5C, 207474, 3C8C8C, 58A4A4, 70B8B8, 84C8C8, 9CDCDC, B0ECEC
006414, 208034, 3C9850, 58B06C, 70C484, 84D89C, 9CE8B4, B0FCC8
445C00, 5C7820, 74903C, 8CAC58, A0C070, B0D484, C4E89C, D4FCB0
805800, 947020, A8843C, BC9C58, CCAC70, DCC084, ECD09C, FCE0B0

PICO-8
000000, 291814
1D2B53, 111D35
7E2553, 422136
008751, 125359
AB5236, 742F29
5F574F, 49333B
C2C3C7, A28879
FFF1E8, F3EF7D
FF004D, BE1250
FFA300, FF6C24
FFEC27, A8E72E
00E436, 00B543
29ADFF, 065AB5
83769C, 754665
FF77A8, FF6E59
FFCCAA, FF9D81

Альтернативная пастельная палитра

оранж       FE7433
гол/бирюз   ADFFF1  17FBE0  08FFC6
син         31AAFF
зел         B3FFAD
кр          FB948B  FB5957  9E482D
роз         FFD9FF
бел/сер     FCFEF1  6E7870
желт        6E7870
желт-оранж  F9DBA7

# Портирование игр

|      платформа |       CGA |       VGA |        ZX |       NES |      SEGA |  APPLE II |    PICO-8 | 
|            4:3 | 640 x 480 | 640 x 480 | 640 x 480 | 640 x 480 | 640 x 480 | 640 x 480 | 640 x 480 |
|  оригинал на 8 | 320 х 200 | 320 х 240 | 256 х 192 | 256 х 224 | 320 х 224 | 280 х 192 | 128 х 128 |
| размер спрайта |        16 |        16 |        16 |        16 |        16 |        16 |        24 |
|  блоки бордюра |   0 x 2.5 |   0 x   0 |   4 x   3 |   4 x   1 |   0 x   1 | 2.5 x   3 |  5.33 x 2 |
|   блоки экрана |  40 x  25 |  40 x  30 |  32 x  24 |  32 x  28 |  40 x  28 |  35 х  24 |  16 х  16 |

|      платформа |      RX80 |      RX86 |
|    соотношение |     4 x 3 |     4 x 3 |
|     разрешение | 640 x 480 | 640 x 480 |
|       оригинал | 320 х 240 | 640 x 480 |
|        upscale |        2x |        1x |
| размер спрайта |       2/8 |        16 |
|   блоки экрана |  40 x  30 |  40 x  30 |

Если мы портируем игры с ZX Spectrum, то там разрешение 32 х 24 блока, размер блока 8 х 8 пкс, разрешение экрана 256 x 192 пкс.

Если мы портируем игры с APPLE II, то там разрешение 28 х 18 блоков, размер блока 10 х 11 пкс, разрешение экрана 280 x 198 пкс.

Если мы портируем игры с CGA, то там разрешение 32 х 20 блоков, размер блока 10 х 10 пкс.

В каждом случае будут плюс блоки по краям экрана до размеров 320 х 240.

Если мы портируем игры на RX86, то разрешение у нас увеличивается до 640 х 480 и теперь мы можем более детально прорисовать спрайты. Также мы можем включить старый режим.

